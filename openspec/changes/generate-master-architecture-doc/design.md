# Design: Master Architecture Document

## Overview

This document specifies the exact structure, content rules, and assembly logic for `ARCHITECTURE.md` — the master architecture reference generated alongside the MkDocs portal site.

## Design Principles

1. **Self-contained**: Every piece of information needed to understand the system is inline. No external links required for comprehension.
2. **Deterministic**: Same inputs always produce the same output. No randomness, no non-deterministic ordering.
3. **Claude-optimized**: Structured for language model context windows, not human browsing. Flat headings, explicit cross-references, structured data over prose.
4. **Graceful degradation**: Missing cached data never causes generation failure. Gaps are explicitly marked, not silently omitted.
5. **Concise**: Target 15-20KB total. Summaries over full content. The goal is architectural understanding, not exhaustive documentation.

## Document Structure Specification

### Header Block

```markdown
# axiOS Enterprise Architecture Reference

> Auto-generated by kcalvelli-portal on YYYY-MM-DD.
> Source: projects.json (N projects, M categories)
> Upload this file to Claude Projects for complete system context.
```

**Rules**:
- Date is ISO 8601 format (YYYY-MM-DD), UTC
- Project and category counts derived from `projects.json`
- This is the only non-deterministic element (date changes daily)

---

### Section 1: System Context

```markdown
## System Context

Keith Calvelli's project ecosystem is a collection of {N} open-source projects
organized into {M} functional categories. The system is built on NixOS (axiOS)
as the foundational platform, with MCP (Model Context Protocol) servers providing
AI integration across multiple domains.

### Core Platform
- **axiOS** (kcalvelli/axios): {description from projects.json}

### Key Subsystems
- **AI Services**: axios-ai-mail, axios-ai-chat
- **MCP Infrastructure**: mcp-journal, nix-devshell-mcp, Ultimate64MCP, mcp-gateway, axios-dav
- **Retro Computing**: c64-stream-viewer, Ultimate64MCP, c64term
- **Developer Tooling**: nix-devshell-mcp, brave-browser-previews, kcalvelli-portal
```

**Assembly logic**:
1. Count projects and tag categories from `projects.json`
2. Identify the `C4Context` project(s) as "Core Platform" (currently only axiOS)
3. Group remaining projects into subsystems by tag affinity:
   - Projects tagged `ai` or `email` → AI Services
   - Projects tagged `mcp-server` → MCP Infrastructure
   - Projects tagged `commodore64` → Retro Computing
   - Projects tagged `development`, `pkgs`, or `docs` → Developer Tooling
   - Projects tagged `rpg` or `calendar`/`orthodox` → Other
4. A project may appear in multiple subsystems if it has multiple relevant tags

---

### Section 2: Project Inventory

```markdown
## Project Inventory

### {Tag displayName} (order N)

{Tag description from tagDefinitions}

| Project | Repository | Tech Stack | Status | Description |
|---------|-----------|------------|--------|-------------|
| {displayName} | kcalvelli/{repo} | {stack} | {status} | {description} |
```

**Assembly logic**:
1. Iterate `tagDefinitions` sorted by `order`
2. For each tag, find projects whose **primary tag** (first in tags array) matches
3. Tech Stack is extracted from:
   - Cached `*_files.json`: presence of `Cargo.toml` → Rust, `pyproject.toml` → Python, `package.json` → Node.js, `flake.nix` → Nix
   - Cached `*_flake.nix`: language-specific build helpers (e.g., `rustPlatform`, `buildPythonPackage`)
   - Fallback: "Nix" (all projects are Nix flakes)
4. Status is derived from:
   - Cached `*_releases.json`: if has releases → "Released (vX.Y.Z)"
   - If no releases → "In Development"
5. Description is copied verbatim from `projects.json`

---

### Section 3: MCP Server Topology

```markdown
## MCP Server Topology

This ecosystem includes {N} MCP server implementations that provide AI tool access
to various system capabilities.

### Server Inventory

| Server | Transport | Target System | Claude Integration |
|--------|-----------|--------------|-------------------|
| mcp-journal | STDIO | systemd journalctl | Direct (claude_desktop_config) |
| nix-devshell-mcp | STDIO | Nix/direnv | Direct (claude_desktop_config) |
| Ultimate64MCP | STDIO | Ultimate 64 hardware (REST) | Direct (claude_desktop_config) |
| axios-ai-mail | STDIO | IMAP/SMTP email | Direct (claude_desktop_config) |
| axios-dav | STDIO | CalDAV/CardDAV servers | Direct (claude_desktop_config) |
| mcp-gateway | HTTP+SSE | Aggregates other MCP servers | Proxy (OAuth2) |

### Server Relationships

mcp-gateway acts as an aggregation layer that can proxy requests to any of the
above STDIO-based servers, exposing them via HTTP transport with OAuth2 authentication.

### MCP Data Flow

Client (Claude Code / Claude Desktop)
  → Direct STDIO connection → Individual MCP servers → Target systems
  → HTTP connection → mcp-gateway → Proxied MCP servers → Target systems
```

**Assembly logic**:
1. Filter `projects.json` for projects tagged `mcp-server`
2. For each MCP server, extract transport and target from:
   - `docs/<repo>.md` architecture section (primary source)
   - Cached `*_readme.md` (supplemental)
   - Project description in `projects.json` (fallback)
3. Identify mcp-gateway's special aggregation role from its description
4. Note: axios-dav has MCP integration per its description but is tagged `axios`, `caldav` — include it based on description keyword "MCP integration"

---

### Section 4: Integration Patterns

```markdown
## Integration Patterns

### Pattern: NixOS Module Composition
Projects in the axiOS ecosystem are composed as NixOS modules imported into a
host flake configuration. axiOS provides the base system; ecosystem projects
(axios-monitor, axios-ai-mail, axios-ai-chat, axios-dav) extend it declaratively.

Composition chain: User flake → imports axiOS → enables ecosystem modules

### Pattern: MCP Bridge/Adapter
MCP servers follow a consistent three-layer pattern:
  Client (Claude) → MCP Server (Python/adapter) → Target System (native protocol)
Each server translates MCP tool calls into domain-specific operations.

Applied in: mcp-journal (journalctl), nix-devshell-mcp (Nix CLI), Ultimate64MCP (REST API)

### Pattern: Streaming Media Pipeline
Commodore 64 tools use a hardware→network→display pipeline:
  Ultimate 64 hardware → UDP stream → c64-stream-viewer (Wayland/GStreamer)
  Ultimate 64 hardware → REST API → Ultimate64MCP → Claude (MCP)

### Pattern: Nix Flake Distribution
All projects are packaged as Nix flakes, enabling:
- Reproducible builds via `nix build`
- Development shells via `nix develop`
- Declarative system integration via NixOS modules
- Cross-project dependency management via flake inputs
```

**Assembly logic**:
1. Patterns are inferred from tag groupings and architectural analysis:
   - All `axios`-tagged projects → NixOS Module Composition pattern
   - All `mcp-server`-tagged projects → MCP Bridge/Adapter pattern
   - All `commodore64`-tagged projects → Streaming Media Pipeline pattern
   - All projects with `flake.nix` → Nix Flake Distribution pattern
2. For each pattern, list the projects that implement it
3. Extract protocol details from `docs/<repo>.md` architecture sections

---

### Section 5: Technology Decisions

```markdown
## Technology Decisions

| Decision | Choice | Rationale | Projects |
|----------|--------|-----------|----------|
| OS Foundation | NixOS | Declarative, reproducible system configuration | All (axiOS base) |
| Package Management | Nix Flakes | Hermetic builds, pinned dependencies, composable | All 15 projects |
| MCP Server Language | Python | FastAPI/uvicorn ecosystem, rapid prototyping | mcp-journal, nix-devshell-mcp, axios-ai-mail, axios-dav |
| Stream Processing | Rust + GStreamer | Performance-critical media pipeline | c64-stream-viewer |
| MCP Transport | STDIO (primary) | Simple, local, no auth overhead | 5 MCP servers |
| MCP Aggregation | HTTP + SSE + OAuth2 | Remote access, multi-server proxy | mcp-gateway |
| Documentation | MkDocs Material | Markdown-native, Mermaid support, GitHub Pages | kcalvelli-portal |
| Diagrams | Mermaid C4 | Architecture-as-code, version-controlled | kcalvelli-portal |
```

**Assembly logic**:
1. Technology choices are extracted from:
   - Cached `*_flake.nix` files (build system, language, dependencies)
   - Cached `*_files.json` (file structure → language detection)
   - `docs/<repo>.md` architecture sections (protocols, frameworks)
2. Projects column lists all projects using that technology
3. Rationale is synthesized from the technology choice and its context within the ecosystem

---

### Section 6: Dependency Graph

```markdown
## Dependency Graph

### Flake Input Dependencies

axiOS (kcalvelli/axios)
  ← axios-monitor (imports axiOS as flake input)
  ← axios-ai-mail (imports axiOS modules)
  ← axios-ai-chat (imports axiOS modules)
  ← axios-dav (imports axiOS modules)

nixpkgs
  ← All 15 projects (standard Nix package set)

### Runtime Dependencies

mcp-gateway
  → mcp-journal (proxies via MCP protocol)
  → nix-devshell-mcp (proxies via MCP protocol)
  → Ultimate64MCP (proxies via MCP protocol)
  → axios-ai-mail (proxies via MCP protocol)
  → axios-dav (proxies via MCP protocol)

Ultimate64MCP
  → Ultimate 64 hardware (REST API over LAN)

c64-stream-viewer
  → Ultimate 64 hardware (UDP video/audio stream)
```

**Assembly logic**:
1. Flake input dependencies: parse `*_flake.nix` cached files for `inputs = { ... }` blocks
2. Where flake.nix is not cached, infer from tags:
   - `axios`-tagged projects likely import axiOS as a flake input
   - All projects import nixpkgs
3. Runtime dependencies: infer from architecture sections in `docs/<repo>.md`
4. Use text-based tree notation (not Mermaid) for Claude readability

---

### Section 7: Maintenance Status

```markdown
## Maintenance Status

| Project | Latest Release | Last Commit | Release Count | Health |
|---------|---------------|-------------|---------------|--------|
| axiOS | v2026.01.13 | 2026-01-13 | 5 | Active |
| mcp-journal | - | 2026-01-20 | 0 | In Development |
| ... | ... | ... | ... | ... |
```

**Assembly logic**:
1. Latest release from cached `*_releases.json` (where available)
2. Last commit date from GitHub API (already fetched during Phase 2)
3. Health classification:
   - Has release in last 90 days → "Active"
   - Has commits in last 90 days but no release → "In Development"
   - No activity in 90+ days → "Dormant"
   - No cached data → "Unknown"

---

## Size Budget

Target total size: **15-20KB** to fit comfortably within Claude Projects context limits while leaving room for conversation.

| Section | Estimated Size | Notes |
|---------|---------------|-------|
| Header + System Context | ~1KB | Fixed structure |
| Project Inventory | ~4KB | 15 projects x ~250 bytes each |
| MCP Server Topology | ~2KB | 6 servers with relationships |
| Integration Patterns | ~2KB | 4 patterns with examples |
| Technology Decisions | ~2KB | Table format, concise rationale |
| Dependency Graph | ~2KB | Tree notation |
| Maintenance Status | ~2KB | Table format |
| **Total** | **~15KB** | Within budget |

## Handling Missing Data

When cached data files are absent for a project (currently 9 of 15):

| Data Point | Fallback Strategy |
|------------|------------------|
| Tech Stack | Default to "Nix" (all projects are flakes); refine if `docs/<repo>.md` mentions specific tech |
| Dependencies | Infer from tags: `axios`-tagged → depends on axiOS; `mcp-server`-tagged → MCP protocol |
| Release info | Mark as "No releases" with "In Development" status |
| Architecture details | Extract from generated `docs/<repo>.md` (always available) |

**Explicit gap marking**: When a data point is inferred rather than confirmed from cached data, the master doc does NOT mark it specially. The portal update workflow will cache data for all projects over successive runs, filling gaps automatically.

## Non-Goals

- **Not a replacement for per-project docs**: Individual `docs/<repo>.md` files remain the detailed reference. The master doc is a cross-cutting summary.
- **Not published to MkDocs site**: This file is for Claude Projects upload only. It is not added to `mkdocs.yml` navigation.
- **Not automatically uploaded**: The user manually copies `ARCHITECTURE.md` to Claude Projects when desired.
